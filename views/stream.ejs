<%- include('./includes/header.ejs') %>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <div class="header bg-primary pb-6">
        <div class="container-fluid">
            <div class="header-body">
                <div class="row align-items-center py-4">
                    <div class="col-lg-6 col-7">
                        <h6 class="h2 text-white d-inline-block mb-0">Live Stream List</h6>

                    </div>

                </div>
            </div>
        </div>
    </div>


    <!-- Page content -->
    <div class="container-fluid mt--6">
        <div class="row">
            <div class="col">
                <div class="card">
                    <!-- Card header -->
                    <div class="card-header border-0">





                        <!-- Modal -->
                        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog"
                            aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">

                                    <div class="modal-body">
                                        <video height="100%" width="100%" id="videoElement" controls></video>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" onclick="stopvplaying()" class="btn btn-secondary"
                                            data-dismiss="modal">Close</button>

                                    </div>
                                </div>
                            </div>
                        </div>







                    </div>
                    <!-- Light table -->
                    <div class="table-responsive">
                        <table class="table align-items-center table-flush">
                            <thead class="thead-light">
                                <tr>
                                    <th scope="col" class="sort" data-sort="name">Client Id</th>

                                    <th scope="col" class="sort" data-sort="route">Stream Name</th>
                                    <th scope="col" class="sort" data-sort="route">Live</th>
                                    <th scope="col" class="sort" data-sort="route"></th>
                                    <th scope="col" class="sort" data-sort="route">IP</th>
                                    <th scope="col" class="sort" data-sort="route">Started AT</th>
                                    <th scope="col" class="sort" data-sort="route">Video Info</th>

                                </tr>
                            </thead>
                            <tbody class="list" id="tabledata">

                            </tbody>
                        </table>
                        <h1 id="demo"></h1>
                    </div>

                </div>
            </div>
        </div>
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://cdn.bootcss.com/flv.js/1.5.0/flv.min.js"></script>
        <script>


            //var localhost = "127.0.0.1";
            var localhost = "128.199.27.55";


            loadStreams();

            var allAvailableStreams = [];
            function loadStreams() {
                console.log("called load stream");
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {

                        var obj = JSON.parse(this.responseText);



                        if (obj != null) {
                            var liveStreams = obj.live;
                            // document.getElementById("tabledata").innerHTML = '';
                            for (var strm in liveStreams) {

                                var publisher = liveStreams[strm].publisher;
                                var clientId = publisher.clientId;
                                var stream = publisher.stream;
                                var startTime = publisher.connectCreated;
                                var ip = publisher.ip;
                                var video = publisher.video;


                                if (!allAvailableStreams.includes(stream)) {
                                    allAvailableStreams.push(stream);
                                    var addinTable = ' <tr onmouseover=playVideo("' + stream + '","' + clientId + '")><td data-toggle="modal" data-target="#exampleModal">' + clientId + '</td><td><a href="#" >' + stream + '</a></td><td ><video  id="' + clientId + '" controls height="150" width="150" poster="http://128.199.27.55:3000/assets/img/brand/logo.jpeg" muted> </video></td><td></td><td>' + ip + '</td><td>' + startTime + '</td><td>' + video.height + ' x ' + video.width + '</td></tr>';



                                    document.getElementById("tabledata").innerHTML = document.getElementById("tabledata").innerHTML + addinTable;
                                }



                            }
                            var newavailable = [];
                            for (var strm in liveStreams) {
                                var publ = liveStreams[strm].publisher;

                                var stre = publ.stream;
                                newavailable.push(stre);
                            }

                            var re = compareArray(allAvailableStreams, newavailable);
                            if (!(re == "")) {
                                //alert(re);
                                allAvailableStreams = [];
                                document.getElementById("tabledata").innerHTML = "";

                            }




                        }






                    }
                };
                xhttp.open("GET", "http://" + localhost + ":8000/api/streams", true);
                xhttp.send();



            }

            function compareArray(array1, array2) {

                var a = array1 = array1.filter(val => {
                    if (!array2.includes(val)) {
                        return true;
                    }

                });

                return a;
            }

            async function playVideo(stream, vid) {


                var vurl = "http://" + localhost + ":8000/live/" + stream + '.flv';


                if (flvjs.isSupported()) {

                    if (document.getElementById(vid).paused) {
                        var flvPlayer = flvjs.createPlayer({
                            type: 'flv',
                            url: vurl
                        });
                        flvPlayer.attachMediaElement(document.getElementById(vid));
                        flvPlayer.load();
                        await flvPlayer.play();
                    }
                }
            }

            setInterval(loadStreams, 4000);
        </script>




        <script>
            function openModald() {
                $('#exampleModal').modal('show');
            }
            var flvPlayer;

            function playStream(strm_id) {

                openModald();

                var vurl = "http://" + localhost + ":8000/live/" + strm_id + '.flv';

                if (flvjs.isSupported()) {
                    var videoElement = document.getElementById('videoElement');
                    flvPlayer = flvjs.createPlayer({
                        type: 'flv',
                        url: vurl
                    });
                    flvPlayer.attachMediaElement(videoElement);
                    flvPlayer.load();
                    flvPlayer.play();
                }

            }


            function stopvplaying() {
                console.log("seraj", "playing")
                flvPlayer.pause();

            }
        </script>





    </div>

    <%- include('./includes/footer.ejs') %>